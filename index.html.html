
<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TIR — NPV (VPL) em função da taxa de desconto mensal</title>
<style>
  :root { --fg:#222; --muted:#777; --bg:#fff; --accent:#000; }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;}
  body{margin:24px;background:var(--bg);color:var(--fg);}
  h1{font-size:20px;margin:0 0 12px;}
  .wrap{display:grid;grid-template-columns:330px 1fr; gap:20px; align-items:start;}
  .card{border:1px solid #e5e5e5;border-radius:14px;padding:16px;box-shadow:0 1px 8px rgba(0,0,0,.04);}
  .ctrl{margin-bottom:14px;}
  .ctrl label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px;}
  .ctrl input[type=range]{width:100%;}
  .row{display:flex;gap:8px;align-items:center;justify-content:space-between;}
  .row .val{font-variant-numeric:tabular-nums; font-weight:600;}
  .note{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35;}
  canvas{width:100%;height:520px;border:1px solid #eee;border-radius:12px;background:#fff;}
  .btns{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;}
  button{padding:8px 12px;border:1px solid #ddd;border-radius:10px;background:#fafafa;cursor:pointer}
  button:hover{background:#f0f0f0}
  .pill{display:inline-block;padding:2px 8px;border:1px solid #e0e0e0;border-radius:999px;font-size:12px;margin-right:6px;}
  .stat{font-size:14px;margin:6px 0;}
</style>
</head>
<body>
  <h1>TIR — NPV (VPL) em função da taxa de desconto mensal</h1>
  <div class="wrap">
    <div class="card" id="controls">
      <div class="ctrl">
        <label>Política do Pix</label>
        <div class="row">
          <div>
            <label class="pill"><input type="radio" name="pol" value="repassado" checked> Repassado</label>
            <label class="pill"><input type="radio" name="pol" value="absorvido"> Absorvido</label>
            <label class="pill"><input type="radio" name="pol" value="custom"> Personalizado</label>
          </div>
        </div>
      </div>
      <div class="ctrl">
        <label>Investimento inicial (t0)</label>
        <div class="row">
          <input id="inv" type="range" min="1000" max="15000" step="50" value="5145.60">
          <div class="val" id="invv"></div>
        </div>
      </div>
      <div class="ctrl">
        <label>Resultado mensal (após fixos)</label>
        <div class="row">
          <input id="mens" type="range" min="200" max="3000" step="25" value="1325.26">
          <div class="val" id="mensv"></div>
        </div>
        <div class="note">Repassado (padrão): R$ 1.325,26 | Absorvido: R$ 1.116,27</div>
      </div>
      <div class="ctrl">
        <label>Horizonte (meses)</label>
        <div class="row">
          <input id="nmes" type="range" min="6" max="36" step="1" value="12">
          <div class="val" id="nmesv"></div>
        </div>
      </div>
      <div class="ctrl">
        <label>Taxa máxima no eixo (a.m.)</label>
        <div class="row">
          <input id="tmax" type="range" min="0.20" max="3.00" step="0.05" value="1.00">
          <div class="val" id="tmaxv"></div>
        </div>
      </div>
      <div class="stat" id="stat"></div>
      <div class="btns">
        <button id="btnReset">Resetar</button>
        <button id="btnPng">Baixar PNG</button>
      </div>
    </div>

    <div class="card">
      <canvas id="chart" width="1000" height="560"></canvas>
      <div class="note">A curva mostra o NPV (VPL) para diferentes taxas de desconto mensais. A TIR é o ponto onde a curva cruza a linha horizontal (NPV = 0). Valores padrão do TeachSeek (MVP): investimento R$ 5.145,60; resultado mensal R$ 1.325,26 (Pix repassado); horizonte 12 meses.</div>
    </div>
  </div>

<script>
function brl(x){ return 'R$ ' + x.toLocaleString('pt-BR', {maximumFractionDigits:2}); }
function pct(x){ return (x*100).toFixed(2) + '%'; }
function npv(rate, cashflows){
  let s = 0;
  for(let t=0;t<cashflows.length;t++) s += cashflows[t] / Math.pow(1+rate, t);
  return s;
}
function irrBisection(cashflows, low=-0.99, high=5.0, tol=1e-8, maxIter=200){
  function f(r){ return npv(r, cashflows); }
  let fLow=f(low), fHigh=f(high);
  let tries=0, exp=high;
  while(fLow*fHigh>0 && exp<100){
    exp*=2.0; fHigh=f(exp); tries++; if(tries>10) break;
  }
  if(fLow*fHigh>0) return NaN;
  for(let i=0;i<maxIter;i++){
    const mid=(low+high)/2.0, fMid=f(mid);
    if(Math.abs(fMid)<tol) return mid;
    if(fLow*fMid<0){ high=mid; fHigh=fMid; } else { low=mid; fLow=fMid; }
  }
  return (low+high)/2.0;
}

const defaults = { inv:5145.60, repassado:1325.26, absorvido:1116.27, nmes:12, tmax:1.00 };
const els = {
  inv:  document.getElementById('inv'),
  mens: document.getElementById('mens'),
  nmes: document.getElementById('nmes'),
  tmax: document.getElementById('tmax'),
  invv: document.getElementById('invv'),
  mensv: document.getElementById('mensv'),
  nmesv: document.getElementById('nmesv'),
  tmaxv: document.getElementById('tmaxv'),
  stat: document.getElementById('stat'),
  canvas: document.getElementById('chart'),
  btnReset: document.getElementById('btnReset'),
  btnPng: document.getElementById('btnPng'),
  radios: document.querySelectorAll('input[name=pol]')
};

function updateLabels(){
  els.invv.textContent  = brl(parseFloat(els.inv.value));
  els.mensv.textContent = brl(parseFloat(els.mens.value));
  els.nmesv.textContent = parseInt(els.nmes.value);
  els.tmaxv.textContent = pct(parseFloat(els.tmax.value));
}

function draw(){
  const pol = [...els.radios].find(r=>r.checked).value;
  if(pol==='repassado'){ els.mens.value = defaults.repassado; }
  if(pol==='absorvido'){ els.mens.value = defaults.absorvido; }
  els.mens.disabled = (pol!=='custom');

  const inv  = parseFloat(els.inv.value);
  const mensalEf = (pol==='repassado') ? defaults.repassado : (pol==='absorvido' ? defaults.absorvido : parseFloat(els.mens.value));
  const nmes = parseInt(els.nmes.value);
  const tmax = parseFloat(els.tmax.value);

  const cashflows = [-inv]; for(let i=0;i<nmes;i++) cashflows.push(mensalEf);

  const N=600;
  const rates = Array.from({length:N}, (_,i)=> i*(tmax/(N-1)));
  const npvs  = rates.map(r=> npv(r, cashflows));

  const tir_m = irrBisection(cashflows);
  const tir_a = (isFinite(tir_m) && !isNaN(tir_m)) ? (Math.pow(1+tir_m,12)-1) : NaN;

  const ctx = els.canvas.getContext('2d');
  const W = els.canvas.width, H = els.canvas.height;
  ctx.clearRect(0,0,W,H);

  const m = {l:70, r:20, t:20, b:50};
  const x0=m.l, y0=m.t, x1=W-m.r, y1=H-m.b;
  const plotW=x1-x0, plotH=y1-y0;

  const minY = Math.min(...npvs, -inv*1.1);
  const maxY = Math.max(...npvs,  inv*2.2);
  const yMin = Math.min(minY, -1000);
  const yMax = Math.max(maxY,  2000);

  function x2px(x){ return x0 + (x/tmax)*plotW; }
  function y2py(y){ return y1 - ( (y - yMin) / (yMax - yMin) ) * plotH; }

  // eixos
  ctx.strokeStyle = '#999'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(x0, y1); ctx.lineTo(x1, y1); ctx.stroke();
  const yZero = y2py(0);
  ctx.beginPath(); ctx.moveTo(x0, yZero); ctx.lineTo(x1, yZero); ctx.stroke();

  // ticks X
  ctx.fillStyle = '#555'; ctx.textAlign='center'; ctx.textBaseline='top';
  for(let p=0;p<=tmax+1e-9;p+= (tmax<=1.0?0.1:0.2)){
    const xx = x2px(p);
    ctx.beginPath(); ctx.moveTo(xx, y1); ctx.lineTo(xx, y1+5); ctx.stroke();
    ctx.fillText((p*100).toFixed(0)+'%', xx, y1+8);
  }
  // ticks Y
  ctx.textAlign='right'; ctx.textBaseline='middle';
  const stepY = Math.max(500, Math.round((yMax-yMin)/8/100)*100);
  for(let y=Math.ceil(yMin/stepY)*stepY; y<=yMax; y+=stepY){
    const yy=y2py(y);
    ctx.beginPath(); ctx.moveTo(x0-5, yy); ctx.lineTo(x0, yy); ctx.stroke();
    ctx.fillText(brl(y), x0-8, yy);
  }

  // títulos
  ctx.fillStyle='#000'; ctx.textAlign='center'; ctx.textBaseline='bottom';
  ctx.fillText('TIR — NPV (VPL) em função da taxa de desconto mensal', (x0+x1)/2, y0-4);
  ctx.save(); ctx.rotate(-Math.PI/2); ctx.textAlign='center'; ctx.textBaseline='top';
  ctx.fillText('NPV (VPL) em R$', -(y0+y1)/2, 12); ctx.restore();
  ctx.textAlign='center'; ctx.textBaseline='top';
  ctx.fillText('Taxa de desconto mensal', (x0+x1)/2, H-18);

  // curva NPV
  ctx.strokeStyle = '#000'; ctx.lineWidth=2;
  ctx.beginPath();
  rates.forEach((r, i)=>{
    const X = x2px(r), Y = y2py(npvs[i]);
    if(i===0) ctx.moveTo(X, Y); else ctx.lineTo(X, Y);
  });
  ctx.stroke();

  // linha TIR
  if(isFinite(tir_m) && !isNaN(tir_m)){
    const xT = x2px(Math.min(Math.max(tir_m,0), tmax));
    ctx.setLineDash([6,6]); ctx.strokeStyle='#000'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(xT, y0); ctx.lineTo(xT, y1); ctx.stroke();
    ctx.setLineDash([]);
    ctx.beginPath(); ctx.arc(xT, yZero, 4, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle='#000'; ctx.textAlign='left'; ctx.textBaseline='bottom';
    const txt = `TIR ≈ ${(tir_m*100).toFixed(2)}% a.m.  (${(tir_a*100).toFixed(1)}% a.a.)`;
    ctx.fillText(txt, Math.min(xT+10, x1-5), yZero-6);
    els.stat.innerHTML = `TIR mensal: <b>${(tir_m*100).toFixed(2)}% a.m.</b> &nbsp;|&nbsp; TIR anual equivalente: <b>${(tir_a*100).toFixed(1)}% a.a.</b>`;
  }else{
    els.stat.textContent = 'TIR fora do intervalo — ajuste a taxa máxima ou o horizonte.';
  }

  // labels
  els.invv.textContent  = brl(parseFloat(els.inv.value));
  els.mensv.textContent = brl(parseFloat(els.mens.value));
  els.nmesv.textContent = parseInt(els.nmes.value);
  els.tmaxv.textContent = (parseFloat(els.tmax.value)*100).toFixed(0)+'%';
}

[document.getElementById('inv'),
 document.getElementById('mens'),
 document.getElementById('nmes'),
 document.getElementById('tmax')].forEach(e=> e.addEventListener('input', draw));
document.querySelectorAll('input[name=pol]').forEach(r=> r.addEventListener('change', draw));

document.getElementById('btnReset').addEventListener('click', ()=>{
  document.getElementById('inv').value = defaults.inv;
  document.getElementById('mens').value = defaults.repassado;
  document.getElementById('nmes').value = defaults.nmes;
  document.getElementById('tmax').value = defaults.tmax;
  document.querySelector('input[name=pol][value="repassado"]').checked = true;
  draw();
});

document.getElementById('btnPng').addEventListener('click', ()=>{
  const link = document.createElement('a');
  link.download = 'tir_teachseek_interativo.png';
  link.href = document.getElementById('chart').toDataURL('image/png');
  link.click();
});

draw();
</script>
</body>
</html>
